<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Http;

class SoulMirrorController extends Controller
{
    // 1. à¹à¸ªà¸”à¸‡à¸«à¸™à¹‰à¸²à¸Ÿà¸­à¸£à¹Œà¸¡à¸„à¸³à¸–à¸²à¸¡
    public function index()
    {
        return view('soul-mirror.form');
    }

    // 2. à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸¥à¸°à¸ªà¹ˆà¸‡à¹ƒà¸«à¹‰ AI à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ
    public function analyze(Request $request)
    {
        // à¸£à¸±à¸šà¸„à¹ˆà¸²à¸ˆà¸²à¸à¸Ÿà¸­à¸£à¹Œà¸¡
        $q1 = $request->input('q1');
        $q2 = $request->input('q2');
        $q3 = $request->input('q3');

        $apiKey = env('GEMINI_API_KEY');

        // à¸ªà¸£à¹‰à¸²à¸‡ Prompt (à¸„à¸³à¸ªà¸±à¹ˆà¸‡) à¸—à¸µà¹ˆà¸ˆà¸°à¸ªà¹ˆà¸‡à¹ƒà¸«à¹‰ AI
        // à¹€à¸£à¸²à¸•à¹‰à¸­à¸‡à¸ªà¸±à¹ˆà¸‡ Role à¹à¸¥à¸° Context à¹ƒà¸«à¹‰à¸Šà¸±à¸”à¹€à¸ˆà¸™ à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰ AI à¸•à¸­à¸šà¸¡à¸²à¹ƒà¸™à¸ªà¹„à¸•à¸¥à¹Œà¸—à¸µà¹ˆà¹€à¸£à¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£
        $prompt = "
            à¸šà¸—à¸šà¸²à¸—: à¸„à¸¸à¸“à¸„à¸·à¸­ 'à¸à¸£à¸°à¸ˆà¸à¸§à¸´à¹€à¸¨à¸©' à¸—à¸µà¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸¡à¸­à¸‡à¸—à¸°à¸¥à¸¸à¸–à¸¶à¸‡à¹à¸à¹ˆà¸™à¹à¸—à¹‰à¸‚à¸­à¸‡à¸ˆà¸´à¸•à¸§à¸´à¸à¸à¸²à¸“à¸¡à¸™à¸¸à¸©à¸¢à¹Œà¹„à¸”à¹‰
            à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆ: à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸•à¸±à¸§à¸•à¸™à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸ˆà¸²à¸à¸„à¸³à¸•à¸­à¸š 3 à¸‚à¹‰à¸­à¸™à¸µà¹‰:
            
            à¸„à¸³à¸–à¸²à¸¡ 1: à¸–à¹‰à¸²à¹‚à¸¥à¸à¹à¸•à¸à¸žà¸£à¸¸à¹ˆà¸‡à¸™à¸µà¹‰à¸ˆà¸°à¸—à¸³à¸­à¸°à¹„à¸£? -> à¸„à¸³à¸•à¸­à¸š: \"{$q1}\"
            à¸„à¸³à¸–à¸²à¸¡ 2: à¸ªà¸µà¸—à¸µà¹ˆà¸­à¸˜à¸´à¸šà¸²à¸¢à¸­à¸²à¸£à¸¡à¸“à¹Œà¸Šà¹ˆà¸§à¸‡à¸™à¸µà¹‰? -> à¸„à¸³à¸•à¸­à¸š: \"{$q2}\"
            à¸„à¸³à¸–à¸²à¸¡ 3: à¸ªà¸±à¸•à¸§à¹Œà¸—à¸µà¹ˆà¹€à¸«à¸¡à¸·à¸­à¸™à¸•à¸±à¸§à¹€à¸­à¸‡à¸—à¸µà¹ˆà¸ªà¸¸à¸”? -> à¸„à¸³à¸•à¸­à¸š: \"{$q3}\"

            à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ (à¸‚à¸­à¸ à¸²à¸©à¸²à¸—à¸µà¹ˆà¸ªà¸¥à¸°à¸ªà¸¥à¸§à¸¢ à¸¥à¸¶à¸à¸¥à¸±à¸šà¹à¸•à¹ˆà¸ˆà¸£à¸´à¸‡à¹ƒà¸ˆ):
            1. ðŸŒŠ **à¸ªà¸ à¸²à¸§à¸°à¸ˆà¸´à¸•à¹ƒà¸ˆà¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** (à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸ˆà¸²à¸à¸ªà¸µà¹à¸¥à¸°à¸ªà¸±à¸•à¸§à¹Œ)
            2. ðŸ›¡ï¸ **à¸ˆà¸¸à¸”à¹à¸‚à¹‡à¸‡à¸—à¸µà¹ˆà¸‹à¹ˆà¸­à¸™à¸­à¸¢à¸¹à¹ˆ:** (à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸ˆà¸²à¸à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸à¸—à¸³à¸§à¸±à¸™à¹‚à¸¥à¸à¹à¸•à¸)
            3. ðŸ—ï¸ **à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸§à¸´à¸à¸à¸²à¸“à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¢à¸«à¸²:** (à¸ªà¸£à¸¸à¸›à¸ à¸²à¸žà¸£à¸§à¸¡)
            
            à¸•à¸­à¸šà¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ à¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸š Markdown à¸ˆà¸±à¸”à¹ƒà¸«à¹‰à¸­à¹ˆà¸²à¸™à¸‡à¹ˆà¸²à¸¢
        ";

        // à¸¢à¸´à¸‡ API (à¹ƒà¸Šà¹‰ Gemini 2.5 Flash à¸•à¸±à¸§à¹€à¸”à¸´à¸¡)
        $response = Http::withHeaders([
            'Content-Type' => 'application/json',
        ])->post("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key={$apiKey}", [
            'contents' => [
                ['parts' => [['text' => $prompt]]]
            ]
        ]);

        if ($response->successful()) {
            $data = $response->json();
            $analysis = $data['candidates'][0]['content']['parts'][0]['text'] ?? 'à¸à¸£à¸°à¸ˆà¸à¸¡à¸±à¸§à¸«à¸¡à¸­à¸‡... à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸¡à¸­à¸‡à¹€à¸«à¹‡à¸™à¸ à¸²à¸žà¹„à¸”à¹‰à¹ƒà¸™à¸‚à¸“à¸°à¸™à¸µà¹‰';
            
            // à¸ªà¹ˆà¸‡à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¹„à¸›à¸—à¸µà¹ˆà¸«à¸™à¹‰à¸² result view
            return view('soul-mirror.result', ['analysis' => $analysis]);
        } else {
            return back()->with('error', 'à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸šà¸ˆà¸±à¸à¸£à¸§à¸²à¸¥à¸‚à¸±à¸”à¸‚à¹‰à¸­à¸‡: ' . $response->body());
        }
    }
}